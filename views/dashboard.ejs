<% layout('layout') %>

<h2>Dashboard</h2>

<section>
  <h3>Your Info</h3>
  <table>
    <tbody>
      <tr><td>Name:</td><td><%= user.name %></td></tr>
      <tr><td>User ID:</td><td><%= user.userId %></td></tr>
      <tr><td>Role:</td><td><%= user.role %></td></tr>
    </tbody>
  </table>
  <p><a href="/edit/<%= user._id %>" class="button">Edit Your Info</a></p>
</section>

<section>
  <h3>Your Attendance</h3>
  <% if (records.length === 0) { %>
    <p>No attendance records yet.</p>
  <% } else { %>
    <% const latest = records[records.length - 1]; %>
    <p><strong>Time:</strong> <%= new Date(latest.timestamp).toLocaleString('zh-HK', { timeZone: 'Asia/Hong_Kong' }) %></p>
    <p><strong>Location:</strong> (<%= latest.location.latitude %>, <%= latest.location.longitude %>)</p>
  <% } %>
</section>

<% if (user.role === 'teacher') { %>
  <section>
    <a href="/release" class="button">Release Attendance</a>
    <a href="/create" class="button">Create User</a>
    <a href="/window" class="button">Manage Attendance Window</a>
  </section>

  <section>
    <h3>All Users</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>User ID</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.name %></td>
            <td><%= u.userId %></td>
            <td><%= u.role %></td>
            <td>
              <% if (u._id.toString() === user._id.toString()) { %>
                <a href="/edit/<%= u._id %>">Edit (You)</a>
              <% } else { %>
                <a href="/edit/<%= u._id %>">Edit</a>
                |
                <form action="/delete/<%= u._id %>" method="POST" style="display:inline;">
                  <button type="submit" onclick="return confirm('Are you sure you want to delete this user?')">Delete</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>
<% } %>

